
<LoadDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path: '/home/tom/Synths/Mopho'
        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()
            Button:
                text: "Load"
                on_release: root.load(filechooser.path, filechooser.selection)
<SaveDialog>:
    text_input: text_input
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            path: '/home/tom/Synths/Mopho'
            on_selection: text_input.text = self.selection and self.selection[0] or ''
        TextInput:
            id: text_input
            size_hint_y: None
            height: 30
            multiline: False

        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()
            Button:
                text: "Save"
                on_release: root.save(filechooser.path, text_input.text)

<ConfirmDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        Label:
            text: root.message
        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: "Cancel"
                on_release: root.cancel()
            Button:
                text: "Confirm"
                on_release: root.confirm(root.data)

<HSlideController@SlideController>
    orientation: 'vertical'
    Label:
        #size_hint_x: 0.1
        text: root.name
    Slider:
        orientation: 'horizontal'
        min: root.minimum
        max: root.maximum
        step: 1
        value: root.value 
        on_value: root.value = int(self.value)
    Label:
        #size_hint_x: 0.1
        text: str(root.value)   

<VSlideController@SlideController>
    orientation: 'vertical'
    Label:
        size_hint_y: 0.1
        text: root.name
    Slider:
        orientation: 'vertical'
        min: root.minimum
        max: root.maximum
        step: 1
        value: root.value 
        on_value: root.value = int(self.value)
    Label:
        size_hint_y: 0.1
        text: str(root.value)

<TouchController>           
    orientation: 'vertical'
    on_value: self.display_function(self.value)
    Label:
        text: root.name
        text_size: self.size
        halign: 'center'
        valign: 'bottom'
    Label:
        text: root.display_function(root.value)
        text_size: self.size
        halign: 'center'
        valign: 'top'

<SwitchController>
    orientation: 'horizontal'

<DropDownController>
    orientation: 'vertical'
    Label: 
        text: root.name
    Button:
        text: 'Off'

<ToggleController>
    ToggleButton:
        text: root.name 
        on_state: root.value = 1 if self.state == 'down' else 0
        values: [1]
    
<MultiToggle@ToggleButton> 
    group: self.parent.name
    allow_no_selection: False
    multivalue: False
    on_press: self.parent.value = self.values[0]

<Module@BoxLayout>
    padding: 5
    active: False


    
<MainScreen>:    
    orientation: 'vertical'
    
    BoxLayout:
        size_hint_y: 0.15
        Label:
            text: 'Mopho Controller'
            font_size: 24
        Button:
            size_hint_x: 0.2
            text: 'Load'
            on_press: root.show_load_popup()
        Button:
            size_hint_x: 0.2
            text: 'Save'
            on_press: root.show_save_popup()
        Button:
            size_hint_x: 0.2
            text: 'Recieve'
            on_press: root.request_edit_buffer()
    BoxLayout:
        # Row 1:
        orientation: 'horizontal'
        size_hint_y: 1.2
        Module: # ---------------- Osc 1 --------------------#
            orientation: 'horizontal'
            BoxLayout:    
                orientation: 'vertical'
                BoxLayout:
                    padding: 3
                    SwitchController:
                        id: shape1
                        orientation: 'horizontal'
                        name: 'Osc 1 Shape'
                        nrpn_number: 2
                        #on_value: width1.value = 0 if self.value < 4 else self.value - 4
                        MultiToggle:
                            text: 'Off'
                            values: [0]
                            state: 'down'
                        MultiToggle:
                            text: 'Saw'
                            values: [1]
                        MultiToggle:
                            text: 'Tri'
                            values: [2]
                        MultiToggle:
                            text: 'Saw/Tri'
                            values: [3]
                        MultiToggle:
                            text: 'Pulse'
                            multivalue: True
                            values: range(4,104)
                    TouchController:
                        size_hint_x: 0.2
                        name: 'Pulse Width'
                        id: width1
                        nrpn_number: 2
                        is_sub_controller: True
                        maximum: 99 
                        on_value: shape1.value = self.value + 4  
                BoxLayout:
                    orientation: 'horizontal'
                    TouchController:
                        name: 'Osc 1: Freq'
                        nrpn_number: 0
                        maximum: 120
                        display_function: self.note
                    HSlideController:
                        size_hint_x: 2
                        name: 'Osc 1 Fine'
                        nrpn_number: 1
                        #value: self.value.set_min(-50)
                        minimum: -50
                        maximum: 50
                        offset: 50
                    ToggleController:
                        name: 'Keyboard'
                        nrpn_number: 4
                    TouchController:
                        name: 'Glide'
                        nrpn_number: 3
            VSlideController:
                size_hint_x: 0.1
                name: 'Sub Osc'
                param_number: 5 # Remove?????????????
                nrpn_number: 114 
            
        Module: # ---------------- Osc 2 --------------------#
            orientation: 'horizontal'
            BoxLayout:
                
                orientation: 'vertical'
                BoxLayout:
                    padding: 3
                    SwitchController:
                        orientation: 'horizontal'
                        name: 'Osc 2 Shape'
                        id: shape2 
                        nrpn_number: 7
                        #on_value: width2.value = 0 if self.value < 4 else self.value - 4
                        MultiToggle:
                            text: 'Off'
                            values: [0]
                            state: 'down'
                        MultiToggle:
                            text: 'Saw'
                            values: [1]
                        MultiToggle:
                            text: 'Tri'
                            values: [2]
                        MultiToggle:
                            text: 'Saw/Tri'
                            values: [3]
                        MultiToggle:
                            text: 'Pulse'
                            multivalue: True
                            values: range(4,104)
                    TouchController:
                        size_hint_x: 0.2
                        name: 'Pulse Width'
                        id: width2
                        nrpn_number: 7
                        is_sub_controller: True
                        maximum: 99  
                        on_value: shape2.value = self.value + 4 
                        
                BoxLayout:
                    orientation: 'horizontal'
                    TouchController:
                        name: 'Osc 2: Freq'
                        nrpn_number: 5
                        maximum: 120
                        display_function: self.note
                    HSlideController:
                        size_hint_x: 2
                        name: 'Osc 2 Fine'
                        nrpn_number: 6
                        minimum: -50
                        maximum: 50
                        offset: 50
                    ToggleController:
                        name: 'Keyboard'
                        nrpn_number: 9
                    TouchController:
                        name: 'Glide'
                        nrpn_number: 8
            VSlideController:
                size_hint_x: 0.1
                name: 'Sub Osc'
                nrpn_number: 115
        Module: #----------------Mixer-------------------#
            orientation: 'horizontal'
            size_hint_x: 0.8
            BoxLayout:
                orientation: 'vertical'
                HSlideController:
                    name: 'Osc Mix'
                    nrpn_number: 13
                BoxLayout:
                    orientation: 'horizontal'
                    ToggleController:
                        name: 'Sync'
                        nrpn_number: 10
                    TouchController:
                        name: 'Slop'
                        nrpn_number: 12
                        maximum: 5
                    TouchController:
                        name: 'Bend'
                        nrpn_number: 93
                        maximum: 12
                    TouchController:
                        #size_hint_x: 0.2
                        name: 'Input'
                        nrpn_number: 116  
                #BoxLayout:
                    #orientation: 'horizontal'
                DropDownController:
                    name: 'Glide:'
                    nrpn_number: 11
                    option_list: 'glide'
                    always_on: True
                DropDownController:
                    name: 'Key Assign Priority:'
                    nrpn_number: 96
                    option_list: 'key_assign'
                    always_on: True
            VSlideController:
                size_hint_x: 0.2
                name: 'Noise'
                nrpn_number: 14   
    BoxLayout:
        # Row 2
        orientation: 'horizontal'
        size_hint_y: 1.6
        Module: # ---------------- Filter -------------------#
            orientation: 'horizontal'
            BoxLayout:
                size_hint_x: 0.2
                orientation: 'vertical'
                Label:
                    text: 'Filter\n\nPoles:'
                    size_hint_y: 1.5
                SwitchController:
                    name: 'filter poles'
                    nrpn_number: 19
                    value: 0
                    MultiToggle:
                        text: '2'
                        values: [0]
                        state: 'down'
                    MultiToggle:
                        text: '4'
                        values: [1]   
                TouchController:
                    name: 'Keyboard'
                    nrpn_number: 17
                TouchController:
                    name: 'Mod'
                    nrpn_number: 18
                TouchController:
                    name: 'Velocity'
                    nrpn_number: 21        
            VSlideController:
                size_hint_x: 0.2
                name: 'Cut Off'
                nrpn_number: 15
                maximum: 164
            VSlideController:
                size_hint_x: 0.2
                name: "Resonance"
                nrpn_number: 16
            BoxLayout:
                orientation: 'vertical'
                BoxLayout:
                    orientation: 'horizontal'
                    VSlideController:
                        name: 'Delay'
                        nrpn_number: 22
                    VSlideController:
                        name: 'Attack'
                        nrpn_number: 23
                    VSlideController:
                        name: 'Decay'
                        nrpn_number: 24
                    VSlideController:
                        name: 'Sustain'
                        nrpn_number: 25
                    VSlideController:
                        name: 'Release' 
                        nrpn_number: 26
                HSlideController:
                    #orientation: 'horizontal'
                    size_hint_y: 0.3
                    #pos_hint: {'x': 0.25} 
                    name: 'Envelope Amount' 
                    nrpn_number: 20
                    minimum: -127
                    maximum: 127
                    offset: 127
        Module: #---------------VCA-----------------#
            BoxLayout:
                size_hint_x: 0.2
                orientation: 'vertical'
                Label:
                    text: 'VCA'
                TouchController:
                    name: 'Initial'
                    nrpn_number: 27
                TouchController:
                    name: 'Envelope'
                    nrpn_number: 30        
                TouchController:
                    name: 'Velocity'
                    nrpn_number: 31
                TouchController:
                    name: 'Volume'
                    nrpn_number: 29
            BoxLayout:
                orientation: 'horizontal'
                VSlideController:
                    name: 'Delay'
                    nrpn_number: 32
                VSlideController:
                    name: 'Attack'
                    nrpn_number: 33
                VSlideController:
                    name: 'Decay'
                    nrpn_number: 34
                VSlideController:
                    name: 'Sustain'
                    nrpn_number: 35
                VSlideController:
                    name: 'Release'
                    nrpn_number: 36
    BoxLayout:
        # Row 3:
        orientation: 'horizontal'
        size_hint_y: 3.5
        BoxLayout:
            # Col 1:
            orientation: 'vertical'
            Module: #--------------- Env 3 -----------------#
                orientation: 'horizontal'
                size_hint_y: 0.8
                active: False
                BoxLayout:
                    size_hint_x: 0.2
                    orientation: 'vertical'
                    Label:
                        text: 'Envelope 3'       
                    TouchController:
                        name: 'Velocity'
                        nrpn_number: 59
                    ToggleController:
                        name: 'Repeat'
                        nrpn_number: 98
                Module:
                    orientation: 'vertical'
                    active: False
                    DropDownController:
                        #size_hint_y: 0.5 
                        name: 'Envelope 3 Destination:'
                        nrpn_number: 57
                        option_list: 'destinations'
                        on_value: self.parent.parent.active = True;
                    BoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: 3.5
                        VSlideController:
                            name: 'Delay'
                            nrpn_number: 60
                        VSlideController:
                            name: 'Attack'
                            nrpn_number: 61
                        VSlideController:
                            name: 'Decay'
                            nrpn_number: 62
                        VSlideController:
                            name: 'Sustain'
                            nrpn_number: 63
                        VSlideController:
                            name: 'Release'
                            nrpn_number: 64
                    HSlideController:
                        #size_hint_y: 0.5
                        name: 'Envelope Amount' 
                        nrpn_number: 58
                        minimum: -127
                        maximum: 127
                        offset: 127
                    
            # Col 1 still:
            BoxLayout:
                orientation: 'horizontal'
                size_hint_y: 0.5
            #GridLayout: #------------------Mods--------------------#
                #rows: 2
                #cols: 2
                Module: # ----------Mod 1:----------#
                    orientation: 'vertical'
                    DropDownController:
                        size_hint_y: 0.5 
                        name: 'Mod 1 Source:'
                        nrpn_number: 65
                        option_list: 'sources'
                    HSlideController:
                        name: 'Amount'
                        nrpn_number: 66 
                        minimum: -127
                        maximum: 127
                        offset: 127
                    DropDownController:
                        size_hint_y: 0.5 
                        name: 'Destination:'
                        nrpn_number: 67
                        option_list: 'destinations'
                Module: # ----------Mod 2:----------#
                    orientation: 'vertical'
                    DropDownController:
                        size_hint_y: 0.5 
                        name: 'Mod 2 Source:'
                        nrpn_number: 68
                        option_list: 'sources'
                    HSlideController:
                        name: 'Amount'
                        nrpn_number: 69 
                        minimum: -127
                        maximum: 127
                        offset: 127
                    DropDownController:
                        size_hint_y: 0.5 
                        name: 'Destination:'
                        nrpn_number: 70
                        option_list: 'destinations'
                Module: # ----------Mod 3:----------#
                    orientation: 'vertical'
                    DropDownController:
                        size_hint_y: 0.5 
                        name: 'Mod 3 Source:'
                        nrpn_number: 71
                        option_list: 'sources'
                    HSlideController:
                        name: 'Amount'
                        nrpn_number: 72
                        minimum: -127
                        maximum: 127
                        offset: 127
                    DropDownController:
                        size_hint_y: 0.5 
                        name: 'Destination:'
                        nrpn_number: 73
                        option_list: 'destinations'
                Module: # ----------Mod 4:----------#
                    orientation: 'vertical'
                    DropDownController:
                        size_hint_y: 0.5 
                        name: 'Mod 4 Source:'
                        nrpn_number: 74
                        option_list: 'sources'
                    HSlideController:
                        name: 'Amount'
                        nrpn_number: 75
                        minimum: -127
                        maximum: 127
                        offset: 127
                    DropDownController:
                        size_hint_y: 0.5 
                        name: 'Destination:'
                        nrpn_number: 76
                        option_list: 'destinations'
                Module: # ----------Mod Wheel:----------#
                    orientation: 'vertical'
                    Label:
                        size_hint_y: 0.5
                        text: 'Mod Wheel:'
                    HSlideController:
                        name: 'Amount'
                        nrpn_number: 81
                        minimum: -127
                        maximum: 127
                        offset: 127
                    DropDownController:
                        size_hint_y: 0.5 
                        name: 'Destination:'
                        nrpn_number: 82
                        option_list: 'destinations'
        # Col 2
        GridLayout: #---------------LFOs---------------------#
            rows: 2
            cols: 2
            # LFO 1: 40, 37, 37, 38, 41, 39
            Module:
                orientation: 'vertical'
                DropDownController:
                    size_hint_y: 0.3 
                    name: 'LFO 1 Destination:'
                    nrpn_number: 40
                    option_list: 'destinations'
                    on_value: self.parent.active = True
                BoxLayout:
                    orientation: 'horizontal'
                    BoxLayout:
                        orientation: 'vertical'                            
                        HSlideController:
                            #size_hint_y: 
                            name: 'Freq' 
                            nrpn_number: 37
                            maximum: 150
                        DropDownController:
                            #size_hint_y: 
                            name: 'Time sync:'
                            is_sub_controller: True
                            nrpn_number: 37
                            offset: 151
                            option_list: 'time_syncs'
                        DropDownController:
                            #size_hint_y: 
                            name: 'Shape:'
                            nrpn_number: 38
                            option_list: 'lfo_shapes'
                        ToggleController:
                            name: 'Key Sync'
                            nrpn_number: 41
                            size_hint_y: 0.5                                
                    VSlideController:
                        name: 'Amount'
                        nrpn_number: 39
            # LFO 2: 45, 42, 42, 43, 46, 44
            Module:
                orientation: 'vertical'
                DropDownController:
                    size_hint_y: 0.3 
                    name: 'LFO 2 Destination:'
                    nrpn_number: 45
                    option_list: 'destinations'
                    on_value: self.parent.active = True
                BoxLayout:
                    orientation: 'horizontal'
                    BoxLayout:
                        orientation: 'vertical'                            
                        HSlideController:
                            #size_hint_y: 
                            name: 'Freq' 
                            nrpn_number: 42
                            maximum: 150
                        DropDownController:
                            #size_hint_y: 
                            name: 'Time sync:'
                            is_sub_controller: True
                            nrpn_number: 42
                            offset: 151
                            option_list: 'time_syncs'
                        DropDownController:
                            #size_hint_y: 
                            name: 'Shape:'
                            nrpn_number: 43
                            option_list: 'lfo_shapes'
                        ToggleController:
                            name: 'Key Sync'
                            nrpn_number: 46
                            size_hint_y: 0.5                                                              
                    VSlideController:
                        name: 'Amount'
                        nrpn_number: 44
            # LFO 3: 50, 47, 47, 48, 51, 49
            Module:
                orientation: 'vertical'
                DropDownController:
                    size_hint_y: 0.3
                    name: 'LFO 3 Destination:'
                    nrpn_number: 50
                    option_list: 'destinations'
                    on_value: self.parent.active = True
                BoxLayout:
                    orientation: 'horizontal'
                    BoxLayout:
                        orientation: 'vertical'                            
                        HSlideController:
                            #size_hint_y: 
                            name: 'Freq' 
                            nrpn_number: 47
                            maximum: 150
                        DropDownController:
                            #size_hint_y: 
                            name: 'Time sync:'
                            is_sub_controller: True
                            nrpn_number: 47
                            offset: 151
                            option_list: 'time_syncs'
                        DropDownController:
                            #size_hint_y: 
                            name: 'Shape:'
                            nrpn_number: 48
                            option_list: 'lfo_shapes'
                        ToggleController:
                            name: 'Key Sync'
                            nrpn_number: 51
                            size_hint_y: 0.5                                                                                                   
                    VSlideController:
                        name: 'Amount'
                        nrpn_number: 49
            # LFO 4: 55, 52, 52, 53, 56, 54
            Module:
                orientation: 'vertical'
                DropDownController:
                    size_hint_y: 0.3
                    name: 'LFO 4 Destination:'
                    nrpn_number: 55
                    option_list: 'destinations'
                    on_value: self.parent.active = True
                BoxLayout:
                    orientation: 'horizontal'
                    BoxLayout:
                        orientation: 'vertical'                            
                        HSlideController:
                            #size_hint_y: 
                            name: 'Freq' 
                            nrpn_number: 52
                            maximum: 150
                        DropDownController:
                            #size_hint_y: 
                            name: 'Time sync:'
                            is_sub_controller: True
                            nrpn_number: 52
                            offset: 151
                            option_list: 'time_syncs'
                        DropDownController:
                            #size_hint_y: 
                            name: 'Shape:'
                            nrpn_number: 53
                            option_list: 'lfo_shapes'
                        ToggleController:
                            name: 'Key Sync'
                            nrpn_number: 56
                            size_hint_y: 0.5                                    
                    VSlideController:
                        name: 'Amount'
                        nrpn_number: 54     
